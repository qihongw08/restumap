generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id
  username  String?  @map("username")
  email     String?  @map("email")
  avatarUrl String?  @map("avatar_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Restaurant {
  id               String  @id @default(uuid())
  name             String
  address          String?
  formattedAddress String? @map("formatted_address")
  latitude         Float?
  longitude        Float?

  // Google Places (enriched from import)
  googlePlaceId           String?  @unique @map("google_place_id")
  photoReferences         String[] @default([]) @map("photo_references") // Up to 5 photo references from Place Details; use with /api/places/photo
  openingHoursWeekdayText String[] @default([]) @map("opening_hours_weekday_text") // From Place Details opening_hours.weekday_text

  // Extracted data
  cuisineTypes  String[] @map("cuisine_types")
  popularDishes String[] @map("popular_dishes")
  priceRange    String?  @map("price_range") // $, $$, $$$, $$$$
  ambianceTags  String[] @map("ambiance_tags")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  userRestaurants  UserRestaurant[]
  visits           Visit[]
  photos           Photo[]
  imports          Import[]
  groupRestaurants GroupRestaurant[]

  @@map("restaurants")
}

model UserRestaurant {
  id              String           @id @default(uuid())
  userId          String           @map("user_id")
  restaurantId    String           @map("restaurant_id")
  status          RestaurantStatus @default(WANT_TO_GO)
  isBlacklisted   Boolean          @default(false) @map("is_blacklisted")
  blacklistReason String?          @map("blacklist_reason")
  blacklistedAt   DateTime?        @map("blacklisted_at")
  savedAt         DateTime         @default(now()) @map("saved_at")
  sourceUrl       String?          @map("source_url")
  sourcePlatform  String?          @map("source_platform") // instagram, rednote, tiktok
  rawCaption      String?          @map("raw_caption")
  restaurant      Restaurant       @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([userId, restaurantId])
  @@map("user_restaurants")
}

model Group {
  id               String            @id @default(uuid())
  name             String
  createdById      String            @map("created_by_id")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  members          GroupMember[]
  groupRestaurants GroupRestaurant[]
  invites          GroupInvite[]
  visits           Visit[]

  @@map("groups")
}

model GroupMember {
  id       String   @id @default(uuid())
  groupId  String   @map("group_id")
  userId   String   @map("user_id")
  role     String   @default("member")
  joinedAt DateTime @default(now()) @map("joined_at")
  group    Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@map("group_members")
}

model GroupRestaurant {
  id           String     @id @default(uuid())
  groupId      String     @map("group_id")
  restaurantId String     @map("restaurant_id")
  addedById    String     @map("added_by_id")
  addedAt      DateTime   @default(now()) @map("added_at")
  group        Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([groupId, restaurantId])
  @@map("group_restaurants")
}

model GroupInvite {
  id        String   @id @default(uuid())
  groupId   String   @map("group_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  usedById  String?  @map("used_by_id")
  createdAt DateTime @default(now()) @map("created_at")
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@map("group_invites")
}

model Import {
  id           String     @id @default(uuid())
  userId       String     @map("user_id")
  sourceUrl    String?    @map("source_url") // Original link user pasted (null if caption-only)
  importedAt   DateTime   @default(now()) @map("imported_at")
  restaurantId String     @map("restaurant_id")
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@map("imports")
}

model Visit {
  id           String     @id @default(uuid())
  userId       String     @map("user_id")
  restaurantId String     @map("restaurant_id")
  groupId      String?    @map("group_id")
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  group        Group?     @relation(fields: [groupId], references: [id], onDelete: SetNull)

  visitDate DateTime @map("visit_date")

  fullnessScore Int   @map("fullness_score")
  tasteScore    Int   @map("taste_score")
  pricePaid     Float @map("price_paid")

  notes String?

  photos Photo[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("visits")
}

model Photo {
  id           String     @id @default(uuid())
  userId       String     @map("user_id")
  restaurantId String     @map("restaurant_id")
  visitId      String?    @map("visit_id")
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  visit        Visit?     @relation(fields: [visitId], references: [id], onDelete: Cascade)

  url        String
  caption    String?
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  @@map("photos")
}

enum RestaurantStatus {
  WANT_TO_GO
  VISITED
  FAVORITE
  WARNING_ZONE
}
